<!DOCTYPE html>
<html>
<head>
    <title>Original Audio Recorder</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.js"></script>
    <style>
        body { background: black; margin: 0; padding: 0; }
        #audio-container { display: none; }
    </style>
</head>
<body>
    <div id="audio-container"></div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const wsUrl = urlParams.get('url');
        const token = urlParams.get('token');
        
        const room = new LivekitClient.Room({
            adaptiveStream: false,
            dynacast: false,
        });
        
        const audioContainer = document.getElementById('audio-container');
        
        // Track which participants are humans (not agent, not recorders)
        function isHumanParticipant(participant) {
            const identity = participant.identity;
            // Skip agent and egress recorders
            if (identity === 'agent') return false;
            if (identity.startsWith('EG_')) return false;
            if (identity.includes('EG_')) return false;
            return true;
        }
        
        room.on('trackSubscribed', (track, publication, participant) => {
            if (track.kind === 'audio' && isHumanParticipant(participant)) {
                console.log(`[ORIGINAL] Subscribing to human audio: ${participant.identity}`);
                const audioElement = track.attach();
                audioElement.id = `audio-${participant.identity}-${track.sid}`;
                audioContainer.appendChild(audioElement);
            }
        });
        
        room.on('trackUnsubscribed', (track, publication, participant) => {
            if (track.kind === 'audio') {
                const elements = track.detach();
                elements.forEach(el => el.remove());
            }
        });
        
        room.on('participantConnected', (participant) => {
            console.log(`[ORIGINAL] Participant connected: ${participant.identity}`);
            
            // Unsubscribe from agent tracks
            if (!isHumanParticipant(participant)) {
                participant.trackPublications.forEach((publication) => {
                    if (publication.track && publication.kind === 'audio') {
                        publication.setSubscribed(false);
                    }
                });
            }
        });
        
        // Connect to room
        room.connect(wsUrl, token).then(() => {
            console.log('[ORIGINAL] Connected to room - Recording human audio only');
            
            // Unsubscribe from all agent/non-human tracks
            room.remoteParticipants.forEach((participant) => {
                if (!isHumanParticipant(participant)) {
                    participant.trackPublications.forEach((publication) => {
                        publication.setSubscribed(false);
                    });
                }
            });
        });
    </script>
</body>
</html>