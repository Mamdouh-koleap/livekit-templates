<!DOCTYPE html>
<html>
<head>
    <title>Translated Audio Recorder</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.js"></script>
</head>
<body>
    <div id="audio-container"></div>
    
    <script>
        const audioContainer = document.getElementById('audio-container');
        
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        const url = params.get('url');
        const token = params.get('token');
        
        // Create room with auto-subscribe disabled so we can control subscriptions
        const room = new LivekitClient.Room({
            autoSubscribe: false
        });
        
        // Track subscribed - attach audio for agent only
        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
            // Only attach audio from agent
            if (track.kind === 'audio' && participant.identity === 'agent') {
                console.log('[TRANSLATED] Attaching agent audio:', publication.trackName);
                const element = track.attach();
                element.id = `audio-${track.sid}`;
                audioContainer.appendChild(element);
            }
        });
        
        // Track unsubscribed - cleanup
        room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track) => {
            track.detach().forEach(el => el.remove());
        });
        
        // When a track is published, decide whether to subscribe
        room.on(LivekitClient.RoomEvent.TrackPublished, (publication, participant) => {
            // Subscribe to agent audio tracks only
            if (publication.kind === 'audio' && participant.identity === 'agent') {
                console.log('[TRANSLATED] Subscribing to agent track:', publication.trackName);
                publication.setSubscribed(true);
            } else if (participant.identity !== 'agent') {
                console.log('[TRANSLATED] Ignoring human track');
                publication.setSubscribed(false);
            }
        });
        
        // Handle existing tracks when participant is already in room
        room.on(LivekitClient.RoomEvent.ParticipantConnected, (participant) => {
            participant.trackPublications.forEach((publication) => {
                if (publication.kind === 'audio') {
                    if (participant.identity === 'agent') {
                        publication.setSubscribed(true);
                    } else {
                        publication.setSubscribed(false);
                    }
                }
            });
        });
        
        // Connect to room
        room.connect(url, token).then(() => {
            console.log('[TRANSLATED] Connected to room');
            
            // Process existing participants
            room.remoteParticipants.forEach((participant) => {
                participant.trackPublications.forEach((publication) => {
                    if (publication.kind === 'audio') {
                        if (participant.identity === 'agent') {
                            console.log('[TRANSLATED] Subscribing to existing agent track:', publication.trackName);
                            publication.setSubscribed(true);
                        } else {
                            publication.setSubscribed(false);
                        }
                    }
                });
            });
        }).catch(err => {
            console.error('[TRANSLATED] Connection error:', err);
        });
    </script>
</body>
</html>
